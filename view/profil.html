<!--
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Styles de base pour distinguer les messages envoy√©s et re√ßus */
    .message { margin: 5px; padding: 5px; border-radius: 5px; }
    .sent { background-color: #daf8cb; text-align: right; }
    .received { background-color: #f0f0f0; text-align: left; }
    .timestamp { font-size: 0.8em; color: #888; }
  </style>
</head>
<body>
  
  <div class="container">
    <h2>Profil Utilisateur</h2>
    <div class="profile-info">
      <p><strong>Nom:</strong> <span id="userName">Chargement...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Chargement...</span></p>
      <p><strong>ID:</strong> <span id="userId">Chargement...</span></p>
    </div>
    <button onclick="logout()">Se d√©connecter</button>
  </div>

  
  <div class="container" id="messagerieSection" style="display: none;">
    <h2>Messagerie S√©curis√©e</h2>
    <div class="user-list" id="userList">
      <h3>Utilisateurs</h3>
      <ul id="liste-utilisateurs"></ul>
    </div>
    <div>
      <h4>Messages avec <span id="recipientName">Aucun destinataire s√©lectionn√©</span></h4>
      <div id="messages">S√©lectionner une conversation</div>
      <input type="text" id="messageInput" placeholder="√âcrivez un message...">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <script>
    // Ouverture du WebSocket
    const ws = new WebSocket('ws://localhost:3000');
    let userId = null;              // ID de l'utilisateur connect√©
    let allMessages = [];           // Tableau global regroupant TOUS les messages
    let selectedRecipientId = null; // ID du contact s√©lectionn√©

    // Stocke un message dans allMessages
    function storeMessage(msg) {
      // Si le message n'a pas de champ "expediteur", nous affectons celui de l'utilisateur connect√©.
      if (typeof msg.expediteur === "undefined") {
        console.warn("Message sans expediteur d√©tect√©, affectation de userId:", msg);
        msg.expediteur = userId;
      }
      // On conserve le message tel quel (m√™me si il n'a qu'un champ destinataire)
      allMessages.push(msg);
    }

    // Affiche la conversation entre l'utilisateur connect√© et le contact s√©lectionn√©
    function displayConversation() {
      const messagesBox = document.getElementById("messages");
      messagesBox.innerHTML = "";

      if (!selectedRecipientId || !userId) {
        console.log("Aucun destinataire s√©lectionn√© ou utilisateur non identifi√©.");
        messagesBox.innerHTML = "<p style='color:gray;'>S√©lectionner une conversation</p>";
        return;
      }

      // Filtrer les messages appartenant √† la conversation
      let conversation = allMessages.filter(msg => {
        if (typeof msg.destinataire !== "undefined") {
          return (
            (msg.expediteur === userId && msg.destinataire === selectedRecipientId) ||
            (msg.expediteur === selectedRecipientId && msg.destinataire === userId)
          );
        } else {
          // Si le champ destinataire est absent, on consid√®re que le message appartient √† la conversation
          // si son expediteur est √©gal √† selectedRecipientId (message re√ßu) ou si c'est un message envoy√© (expediteur=userId)
          return (msg.expediteur === selectedRecipientId || msg.expediteur === userId);
        }
      });

      // Tri par date (ordre chronologique)
      conversation.sort((a, b) => new Date(a.date_envoi) - new Date(b.date_envoi));

      if (conversation.length === 0) {
        messagesBox.innerHTML = "<p style='color:gray;'>Aucun message dans cette conversation.</p>";
        return;
      }

      // Affichage des messages filtr√©s
      conversation.forEach(msg => {
        let senderLabel = "";
        // Si le message poss√®de le champ destinataire, on distingue en fonction des valeurs.
        if (typeof msg.destinataire !== "undefined") {
          if (msg.expediteur === userId && msg.destinataire === selectedRecipientId) {
            senderLabel = "Moi";
          } else if (msg.expediteur === selectedRecipientId && msg.destinataire === userId) {
            senderLabel = `Utilisateur ${selectedRecipientId}`;
          }
        } else {
          // Cas particulier: absence de destinataire
          if (msg.expediteur === userId) {
            senderLabel = "Moi";
          } else {
            senderLabel = `Utilisateur ${msg.expediteur}`;
          }
        }
        const content = msg.message_dechiffre || "üîí Message chiffr√©";
        displayMessage(content, senderLabel, msg.date_envoi);
      });
    }

    // Affiche un message dans l'interface
    function displayMessage(message, sender, date) {
      console.log("Affichage du message:", message, "De:", sender, "√Ä:", date);
      const messagesBox = document.getElementById("messages");
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");

      if (sender === "Moi") {
        messageElement.classList.add("sent");
      } else {
        messageElement.classList.add("received");
      }

      const formattedDate = new Date(date).toLocaleString([], { hour: '2-digit', minute: '2-digit', hour12: false });
      messageElement.innerHTML = `
        <p>${sender}: ${message}</p>
        <span class="timestamp">${formattedDate}</span>
      `;
      messagesBox.appendChild(messageElement);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // R√©cup√®re tous les messages via AJAX et les stocke dans allMessages
    function fetchMessages() {
      const password = sessionStorage.getItem('userPassword');
      const token = localStorage.getItem('token');
      if (!password || !token || !userId) {
        console.error("Erreur d'identification");
        alert("Erreur d'identification ou de s√©curit√©.");
        return;
      }
      console.log("R√©cup√©ration des messages pour l'utilisateur:", userId);
      $.ajax({
        url: `http://localhost:3000/api/messages/${userId}`,
        method: "GET",
        headers: { 'Authorization': `Bearer ${token}`, 'Password': password },
        success: function (response) {
          console.log("Messages r√©cup√©r√©s:", response);
          allMessages = []; // R√©initialise pour √©viter les doublons
          response.forEach(msg => {
            storeMessage(msg);
          });
          displayConversation();
        },
        error: function () {
          console.error("Impossible de r√©cup√©rer les messages.");
          alert("Impossible de r√©cup√©rer les messages.");
        }
      });
    }

    // R√©cup√®re et affiche la liste des utilisateurs
    function afficherUtilisateurs() {
      console.log("R√©cup√©ration de la liste des utilisateurs...");
      $.ajax({
        url: 'http://localhost:3000/api/users',
        type: "GET",
        success: function(users) {
          console.log("Utilisateurs r√©cup√©r√©s:", users);
          let html = "";
          users.forEach(user => {
            html += `<li onclick="selectRecipient(${user.id}, '${user.nom}')">${user.nom} (${user.email})</li>`;
          });
          $("#liste-utilisateurs").html(html);
        },
        error: function(xhr) {
          const errorMessage = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Une erreur est survenue';
          console.error("Erreur lors de la r√©cup√©ration des utilisateurs:", errorMessage);
          alert("Erreur: " + errorMessage);
        }
      });
    }

    // Lorsqu'un utilisateur est s√©lectionn√©, on met √† jour selectedRecipientId et on affiche la conversation correspondante
    function selectRecipient(id, name) {
      console.log("Destinataire s√©lectionn√©:", name, "ID:", id);
      selectedRecipientId = id;
      $('#recipientName').text(name);
      displayConversation();
    }

    // Envoi d'un message via AJAX. Le message est ajout√© √† allMessages et la conversation est r√©affich√©e.
    function sendMessage() {
      const message = $('#messageInput').val().trim();
      if (!message || !selectedRecipientId) {
        console.warn("Message ou destinataire manquant");
        alert("Message et destinataire requis.");
        return;
      }
      console.log("Envoi du message:", message, "√†:", selectedRecipientId);
      const data = { expediteur: userId, destinataire: selectedRecipientId, message };
      $.ajax({
        url: "http://localhost:3000/api/send",
        method: "POST",
        contentType: "application/json",
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        data: JSON.stringify(data),
        success: function () {
          const messageObj = {
            expediteur: userId,
            destinataire: selectedRecipientId,
            message_dechiffre: message,
            date_envoi: new Date()
          };
          storeMessage(messageObj);
          displayConversation();
          $('#messageInput').val("");
        },
        error: function () {
          console.error("Erreur lors de l'envoi du message.");
          alert("Erreur d'envoi.");
        }
      });
    }

    // R√©ception des messages via WebSocket
    ws.onmessage = function (event) {
      console.log("Message WebSocket re√ßu:", event.data);
      const newMessage = JSON.parse(event.data);
      storeMessage(newMessage);
      // Si le message appartient √† la conversation affich√©e, actualiser l'affichage
      if ((newMessage.expediteur === selectedRecipientId) || (newMessage.destinataire === selectedRecipientId)) {
        displayConversation();
      }
    };

    // D√©connexion
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }

    // Lors du chargement du document, r√©cup√©rer profil, messages et utilisateurs
    $(document).ready(function () {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }
      console.log("Tentative de r√©cup√©ration du profil...");
      $.ajax({
        url: 'http://localhost:3000/api/profil',
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        success: function (data) {
          console.log("Profil r√©cup√©r√©:", data);
          $('#userName').text(data.nom);
          $('#userEmail').text(data.email);
          $('#userId').text(data.id);
          userId = data.id;
          $('#messagerieSection').show();
          fetchMessages();
          afficherUtilisateurs();
        },
        error: function () {
          console.error("Erreur lors de la r√©cup√©ration du profil.");
          logout();
        }
      });
    });
  </script>
</body>
</html>
--><!--
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Styles de base pour distinguer les messages envoy√©s et re√ßus */
    .message { margin: 5px; padding: 5px; border-radius: 5px; }
    .sent { background-color: #daf8cb; text-align: right; }
    .received { background-color: #f0f0f0; text-align: left; }
    .timestamp { font-size: 0.8em; color: #888; }
  </style>
</head>
<body>
  
  <div class="container">
    <h2>Profil Utilisateur</h2>
    <div class="profile-info">
      <p><strong>Nom:</strong> <span id="userName">Chargement...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Chargement...</span></p>
      <p><strong>ID:</strong> <span id="userId">Chargement...</span></p>
    </div>
    <button onclick="logout()">Se d√©connecter</button>
  </div>

  <div class="container" id="messagerieSection" style="display: none;">
    <h2>Messagerie S√©curis√©e</h2>
    <div class="user-list" id="userList">
      <h3>Utilisateurs</h3>
      <ul id="liste-utilisateurs"></ul>
    </div>
    <div>
      <h4>Messages avec <span id="recipientName">Aucun destinataire s√©lectionn√©</span></h4>
      <div id="messages" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px;">
        <p style="color:gray;">S√©lectionner une conversation</p>
      </div>
      <input type="text" id="messageInput" placeholder="√âcrivez un message..." style="width:80%;">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <script>
    // Ouverture du WebSocket
    const ws = new WebSocket('ws://localhost:3000');
    let userId = null;              // ID de l'utilisateur connect√©
    let allMessages = [];           // Tableau global regroupant TOUS les messages
    let selectedRecipientId = null; // ID du contact s√©lectionn√©

    // Stocke un message dans allMessages
    function storeMessage(msg) {
      if (typeof msg.expediteur === "undefined") {
        msg.expediteur = userId;
      }
      allMessages.push(msg);
    }

    // Affiche un message dans l'interface
    function displayMessage(message, sender, date) {
      const messagesBox = document.getElementById("messages");
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");
      messageElement.classList.add(sender === "Moi" ? "sent" : "received");
      const formattedDate = new Date(date).toLocaleString([], {
        hour: '2-digit', minute: '2-digit', hour12: false
      });
      messageElement.innerHTML = `
        <p><strong>${sender}:</strong> ${message}</p>
        <span class="timestamp">${formattedDate}</span>
      `;
      messagesBox.appendChild(messageElement);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // Affiche la conversation filtr√©e et tri√©e
    function displayConversation() {
      const messagesBox = document.getElementById("messages");
      messagesBox.innerHTML = "";

      if (!selectedRecipientId || !userId) {
        return messagesBox.innerHTML = `<p style="color:gray;">S√©lectionner une conversation</p>`;
      }

      // Filtrer la conversation
      const conversation = allMessages.filter(msg => {
        if (msg.destinataire !== undefined) {
          return (
            (msg.expediteur === userId && msg.destinataire === selectedRecipientId) ||
            (msg.expediteur === selectedRecipientId && msg.destinataire === userId)
          );
        } else {
          return (msg.expediteur === userId || msg.expediteur === selectedRecipientId);
        }
      });

      if (conversation.length === 0) {
        return messagesBox.innerHTML = `<p style="color:gray;">Aucun message dans cette conversation.</p>`;
      }

      // Tri chronologique
      conversation.sort((a, b) =>
        new Date(a.date_envoi) - new Date(b.date_envoi)
      );

      // Affichage
      conversation.forEach(msg => {
        let senderLabel;
        if (msg.expediteur === userId && msg.destinataire === selectedRecipientId) {
          senderLabel = "Moi";
        } else if (msg.expediteur === selectedRecipientId && msg.destinataire === userId) {
          senderLabel = `Utilisateur ${selectedRecipientId}`;
        } else if (msg.expediteur === userId) {
          senderLabel = "Moi";
        } else {
          senderLabel = `Utilisateur ${msg.expediteur}`;
        }
        const content = msg.message_dechiffre || "üîí Message chiffr√©";
        displayMessage(content, senderLabel, msg.date_envoi);
      });
    }

    // R√©cup√®re RSA + AES, assemble et trie
    function fetchAllMessages() {
      const password = sessionStorage.getItem('userPassword');
      const token    = localStorage.getItem('token');
      if (!password || !token || !userId) {
        return alert("Erreur d'identification ou de s√©curit√©.");
      }

      const rsaReq = $.ajax({
        url: `http://localhost:3000/api/messages/${userId}`,
        method: "GET",
        headers: { 'Authorization': `Bearer ${token}`, 'Password': password }
      });
      const aesReq = $.ajax({
        url: `http://localhost:3000/api/conversations?userId=${userId}`,
        method: "GET",
        headers: { 'Authorization': `Bearer ${token}`, 'Password': password }
      });

      $.when(rsaReq, aesReq)
       .done(function(rsaRes, aesRes) {
         const rsaMsgs = rsaRes[0];
         const aesMsgs = aesRes[0];
         allMessages = [];
         rsaMsgs.concat(aesMsgs).forEach(storeMessage);
         allMessages.sort((a, b) =>
           new Date(a.date_envoi) - new Date(b.date_envoi)
         );
         displayConversation();
       })
       .fail(function() {
         alert("Impossible de r√©cup√©rer les messages.");
       });
    }

    // Liste des utilisateurs
    function afficherUtilisateurs() {
      $.ajax({
        url: 'http://localhost:3000/api/users',
        type: "GET",
        success: function(users) {
          let html = "";
          users.forEach(user => {
            html += `<li onclick="selectRecipient(${user.id}, '${user.nom}')">${user.nom} (${user.email})</li>`;
          });
          $("#liste-utilisateurs").html(html);
        },
        error: function(xhr) {
          const err = xhr.responseJSON?.error || 'Une erreur est survenue';
          alert("Erreur: " + err);
        }
      });
    }

    // S√©lection d'un destinataire
    function selectRecipient(id, name) {
      selectedRecipientId = id;
      $('#recipientName').text(name);
      displayConversation();
    }

    // Envoi d'un message
    function sendMessage() {
      const message = $('#messageInput').val().trim();
      if (!message || !selectedRecipientId) {
        return alert("Message et destinataire requis.");
      }
      const data = {
        expediteur: userId,
        destinataire: selectedRecipientId,
        message
      };
      $.ajax({
        url: "http://localhost:3000/api/send",
        method: "POST",
        contentType: "application/json",
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        data: JSON.stringify(data),
        success: function () {
          const messageObj = {
            expediteur: userId,
            destinataire: selectedRecipientId,
            message_dechiffre: message,
            date_envoi: new Date().toISOString()
          };
          storeMessage(messageObj);
          allMessages.sort((a, b) =>
            new Date(a.date_envoi) - new Date(b.date_envoi)
          );
          displayConversation();
          $('#messageInput').val("");
        },
        error: function () {
          alert("Erreur d'envoi.");
        }
      });
    }

    // R√©ception via WebSocket
    ws.onmessage = function (event) {
      const newMessage = JSON.parse(event.data);
      storeMessage(newMessage);
      if (newMessage.expediteur === selectedRecipientId ||
          newMessage.destinataire === selectedRecipientId) {
        displayConversation();
      }
    };

    // D√©connexion
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }

    // Initialisation au chargement
    $(document).ready(function () {
      const token = localStorage.getItem('token');
      if (!token) {
        return window.location.href = '/login';
      }
      $.ajax({
        url: 'http://localhost:3000/api/profil',
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        success: function (data) {
          $('#userName').text(data.nom);
          $('#userEmail').text(data.email);
          $('#userId').text(data.id);
          userId = data.id;
          $('#messagerieSection').show();
          fetchAllMessages();
          afficherUtilisateurs();
        },
        error: logout
      });
    });
  </script>

</body>
</html>--><!--
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Messagerie Temps R√©el</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .message { margin:5px; padding:5px; border-radius:5px; }
    .sent    { background-color:#daf8cb; text-align:right; }
    .received{ background-color:#f0f0f0; text-align:left; }
    .timestamp{ font-size:0.8em; color:#888; }
    #messages{ height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px; }
    .user-list{ float:left; width:25%; }
    .conversation{ margin-left:27%; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Profil Utilisateur</h2>
    <div class="profile-info">
      <p><strong>Nom:</strong>   <span id="userName">Chargement...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Chargement...</span></p>
      <p><strong>ID:</strong>    <span id="userId">Chargement...</span></p>
    </div>
    <button onclick="logout()">Se d√©connecter</button>
  </div>

  <div class="container" id="messagerieSection" style="display:none; margin-top:20px;">
    <h2>Messagerie S√©curis√©e</h2>
    <div class="user-list">
      <h3>Utilisateurs</h3>
      <ul id="liste-utilisateurs"></ul>
    </div>
    <div class="conversation">
      <h4>Messages avec <span id="recipientName">Aucun destinataire s√©lectionn√©</span></h4>
      <div id="messages">
        <p style="color:gray;">S√©lectionner une conversation</p>
      </div>
      <div style="margin-top:10px;">
        <select id="encryptionType">
          <option value="rsa">RSA</option>
          <option value="aes">AES</option>
        </select>
        <input type="text" id="messageInput" placeholder="√âcrivez un message..." style="width:60%;">
        <button id="btnSend">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    let userId = null,
        ws = null,
        allMessages = [],
        selectedRecipientId = null;

    // Evite les doublons par (expediteur,destinataire,date,message)
    function isDuplicate(msg) {
      return allMessages.some(m =>
        m.expediteur == msg.expediteur &&
        m.destinataire == msg.destinataire &&
        m.date_envoi == msg.date_envoi &&
        m.message_dechiffre == (msg.message_dechiffre || msg.message)
      );
    }

    function storeMessage(msg) {
      // standardisation du champ message_dechiffre
      if (!msg.message_dechiffre && msg.message) {
        msg.message_dechiffre = msg.message;
      }
      if (!isDuplicate(msg)) {
        allMessages.push(msg);
      }
    }

    function displayMessage(text, sender, date) {
      const box = $('#messages');
      const cls = sender === 'Moi' ? 'sent' : 'received';
      const time = new Date(date)
                     .toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      box.append(`
        <div class="message ${cls}">
          <p><strong>${sender}:</strong> ${text}</p>
          <span class="timestamp">${time}</span>
        </div>
      `);
      box.scrollTop(box.prop('scrollHeight'));
    }

    function displayConversation() {
      const box = $('#messages').empty();
      if (!selectedRecipientId) {
        return box.html(`<p style="color:gray;">S√©lectionner une conversation</p>`);
      }
      const conv = allMessages
        .filter(m =>
          (m.expediteur == userId && m.destinataire == selectedRecipientId) ||
          (m.expediteur == selectedRecipientId && m.destinataire == userId)
        )
        .sort((a,b)=> new Date(a.date_envoi) - new Date(b.date_envoi));

      if (!conv.length) {
        return box.html(`<p style="color:gray;">Aucun message dans cette conversation.</p>`);
      }
      conv.forEach(m => {
        const sender = m.expediteur == userId ? 'Moi' : `Utilisateur ${m.expediteur}`;
        displayMessage(m.message_dechiffre, sender, m.date_envoi);
      });
    }

    function connectWebSocket() {
      ws = new WebSocket(`ws://localhost:3000/?userId=${userId}`);
      ws.onopen = () => console.log('WebSocket connect√©');
      ws.onmessage = ev => {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'chat') {
          const p = msg.payload;
          storeMessage(p);
          // n'affiche que si c'est la conversation en cours
          if (p.expediteur == selectedRecipientId || p.destinataire == selectedRecipientId) {
            displayConversation();
          }
        }
      };
      ws.onclose = () => console.log('WebSocket ferm√©');
      ws.onerror = e => console.error('WS error', e);
    }

    function fetchAllMessages() {
      const pwd = sessionStorage.getItem('userPassword'),
            tok = localStorage.getItem('token');
      if (!pwd||!tok||!userId) return alert('Erreur d‚Äôidentification.');

      const rsaReq = $.ajax({ url:`/api/messages/${userId}`, headers:{'Authorization':`Bearer ${tok}`,'Password':pwd} });
      const aesReq = $.ajax({ url:`/api/conversations?userId=${userId}`, headers:{'Authorization':`Bearer ${tok}`,'Password':pwd} });

      $.when(rsaReq, aesReq)
       .done((rsaRes,aesRes)=>{
         allMessages = [];
         rsaRes[0].concat(aesRes[0]).forEach(storeMessage);
         displayConversation();
       })
       .fail(()=>alert('Impossible de r√©cup√©rer les messages.'));
    }

    function afficherUtilisateurs() {
      $.ajax({
        url:'/api/users', method:'GET',
        success(users) {
          $('#liste-utilisateurs').html(
            users.map(u=>
              `<li onclick="selectRecipient(${u.id},'${u.nom}')">
                 ${u.nom} (${u.email})
               </li>`
            ).join('')
          );
        },
        error(xhr){ alert('Erreur: '+(xhr.responseJSON?.error||xhr.statusText)); }
      });
    }

    function selectRecipient(id,name) {
      selectedRecipientId = id;
      $('#recipientName').text(name);
      displayConversation();
    }

    function sendMessage() {
      const text = $('#messageInput').val().trim(),
            type = $('#encryptionType').val();
      if (!text||!selectedRecipientId) {
        return alert('Message et destinataire requis.');
      }
      const payload = {
        expediteur:   userId,
        destinataire: selectedRecipientId,
        message:      text,
        date_envoi:   new Date().toISOString()
      };
      // 1) WS en temps r√©el
      ws.send(JSON.stringify({ type:'chat', payload }));
      // 2) Persistance
      const url = type==='rsa' ? '/api/send' : '/api/sendMessage';
      $.ajax({
        url, method:'POST', contentType:'application/json',
        headers:{ 'Authorization':'Bearer '+localStorage.getItem('token') },
        data: JSON.stringify({
          expediteur: payload.expediteur,
          destinataire: payload.destinataire,
          message: payload.message
        }),
        error: ()=>alert(`Erreur d'envoi ${type.toUpperCase()}.`)
      });
      $('#messageInput').val('');
      // Ne fait PAS de storeMessage ni displayConversation ici
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }

    // Init
    $(document).ready(()=>{
      const tok = localStorage.getItem('token');
      if (!tok) return window.location='/login';

      // Profil
      $.ajax({
        url:'/api/profil', headers:{'Authorization':'Bearer '+tok},
        success(data){
          $('#userName').text(data.nom);
          $('#userEmail').text(data.email);
          $('#userId').text(data.id);
          userId = data.id;
          $('#messagerieSection').show();
          // WebSocket + donn√©es
          connectWebSocket();
          fetchAllMessages();
          afficherUtilisateurs();
        },
        error:logout
      });

      $('#btnSend').click(sendMessage);
    });
  </script>
</body>
</html>
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Profil Utilisateur</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #3b3b3b;
      margin: 10px;
      padding: 10px;
      padding-right: 40px;
    }
  
    .container {
      padding: 20px;
      width: 100%;
      margin: auto;
      background-color: #484949;
      border-radius: 10px;
      margin-top: 5px;
    }
  
    h2, h3, h4 {
      color: #ffffff;
      margin-bottom: 10px;
    }
  
    .profile-info p {
      margin: 5px 0;
      font-size: 16px;
      color: white;
    }
  
    button {
      background-color: #25D366;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
  
    button:hover {
      background-color: #1ebe5d;
    }
  
    #messagerieSection {
      display: flex;
      flex-direction: row;
      gap: 20px;
      height: 500px;
    }
  
    .user-list {
      flex: 1;
      background-color: #686868;
      border-radius: 10px;
      overflow-y: auto;
      padding: 10px;
    }
  
    #liste-utilisateurs {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
    }
  
    #liste-utilisateurs li {
      padding: 10px;
      margin-bottom: 5px;
      background-color: #dcf8c6;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
  
    #liste-utilisateurs li:hover {
      background-color: #cdebbd;
    }
  
    .chat-window {
      flex: 3;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background-color: #686868;
      border-radius: 10px;
      padding: 15px;
      overflow-y: auto;
    }
  
    #messages {
      flex: 1;
      background-color: white;
      padding: 10px;
      border-radius: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
    }
  
    .message-input-container {
      display: flex;
      align-items: center;
    }
  
    #messageInput {
      width: 80%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
      margin-right: 10px;
    }
    
    /* --- Styles sp√©cifiques pour les messages --- */
    .message {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
      position: relative;
    }
    /* Message envoy√© par "Moi" */
    .message.sent {
      background-color: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    /* Message re√ßu de l'autre utilisateur */
    .message.received {
      background-color: #e2e2e2;
      align-self: flex-start;
      text-align: left;
    }
    /* Style pour la date/heure */
    .timestamp {
      display: block;
      font-size: 0.75em;
      color: gray;
      margin-top: 3px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      #messagerieSection {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 style=" margin-left: 40%; margin-top: -5px; margin-bottom: -5px;">Messagerie S√©curis√©e</h2>

    <h2>Profil Utilisateur</h2>
    <div class="profile-info">
      <p><strong>Nom:</strong> <span id="userName">Chargement...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Chargement...</span></p>
      <!--<p><strong>ID:</strong> <span id="userId">Chargement...</span></p>-->
    </div>
    <button style="margin-top: 5px;" onclick="logout()">Se d√©connecter</button>
  </div>

  <!-- Section Messagerie -->
  <div class="container" id="messagerieSection" style="display: none;">
    <div class="user-list" id="userList">
      <h3>Utilisateurs</h3>
      <ul id="liste-utilisateurs"></ul>
    </div>
    <div class="chat-window">
      <h4>Messages avec <span id="recipientName">Aucun destinataire s√©lectionn√©</span></h4>
      <div id="messages">
        <p style="color:gray;">S√©lectionner une conversation</p>
      </div>
      <div style="margin-top:10px;">
        <select id="encryptionType" style="padding: 10px; border-radius: 10px; margin: 10px;">
          <option value="rsa">RSA</option>
          <option value="aes">AES</option>
        </select>
      </div>
      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="√âcrivez un message...">
        <button onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </div>
  <script>
    // Variables globales (sans initialisation imm√©diate pour ws)
    let ws;
    let userId = null;
    let allMessages = [];
    let selectedRecipientId = null;

    // Fonction pour connecter la WebSocket (apr√®s obtention de userId)
    function connectWebSocket() {
      ws = new WebSocket(`ws://localhost:3000/?userId=${userId}`);
      ws.onopen = () => console.log('WebSocket connect√©');
      
      // Au lieu de recharger toute la conversation, nous ajoutons le message directement
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'chat') {
          const p = msg.payload;
          storeMessage(p);
          // Si le message concerne la conversation active, on l'ajoute directement
          if (
            (p.expediteur == selectedRecipientId && p.destinataire == userId) ||
            (p.expediteur == userId && p.destinataire == selectedRecipientId)
          ) {
            // Ajoute uniquement le dernier message sans r√©afficher toute la conversation
            let senderLabel = (p.expediteur == userId) ? "Moi" : `Utilisateur ${p.expediteur}`;
            const content = p.message_dechiffre || "üîí Message chiffr√©";
            displayMessage(content, senderLabel, p.date_envoi);
          }
        }
      };
      ws.onclose = () => console.log('WebSocket ferm√©');
      ws.onerror = (e) => console.error('WS error', e);
    }

    // Stocke un message dans allMessages, en ajoutant une standardisation si n√©cessaire
    function storeMessage(msg) {
      if (typeof msg.expediteur === "undefined") {
        msg.expediteur = userId;
      }
      allMessages.push(msg);
    }

    // Affiche un message (ajout √† la fin de la conversation)
    function displayMessage(message, sender, date) {
      const messagesBox = document.getElementById("messages");
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");
      messageElement.classList.add(sender === "Moi" ? "sent" : "received");
      const formattedDate = new Date(date).toLocaleString([], {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      messageElement.innerHTML = `<p><strong>${sender}:</strong> ${message}</p>
                                   <span class="timestamp">${formattedDate}</span>`;
      messagesBox.appendChild(messageElement);
      // Faire d√©filer automatiquement pour afficher le dernier message
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // La fonction displayConversation r√©affiche toute la conversation.
    // On l'utilise au chargement complet ou lors d'un changement de destinataire.
    function displayConversation() {
      const messagesBox = document.getElementById("messages");
      messagesBox.innerHTML = "";
      if (!selectedRecipientId || !userId) {
        return messagesBox.innerHTML = `<p style="color:gray;">S√©lectionner une conversation</p>`;
      }
      const conversation = allMessages.filter(msg => {
        if (msg.destinataire !== undefined) {
          return (
            (msg.expediteur === userId && msg.destinataire === selectedRecipientId) ||
            (msg.expediteur === selectedRecipientId && msg.destinataire === userId)
          );
        } else {
          return (msg.expediteur === userId || msg.expediteur === selectedRecipientId);
        }
      });
      if (conversation.length === 0) {
        return messagesBox.innerHTML = `<p style="color:gray;">Aucun message dans cette conversation.</p>`;
      }
      conversation.sort((a, b) => new Date(a.date_envoi) - new Date(b.date_envoi));
      conversation.forEach(msg => {
        let senderLabel;
        if (msg.expediteur === userId && msg.destinataire === selectedRecipientId) {
          senderLabel = "Moi";
        } else if (msg.expediteur === selectedRecipientId && msg.destinataire === userId) {
          senderLabel = `Utilisateur ${selectedRecipientId}`;
        } else if (msg.expediteur === userId) {
          senderLabel = "Moi";
        } else {
          senderLabel = `Utilisateur ${msg.expediteur}`;
        }
        const content = msg.message_dechiffre || "üîí Message chiffr√©";
        displayMessage(content, senderLabel, msg.date_envoi);
      });
    }

    // Appels AJAX pour r√©cup√©rer les messages (RSA + AES) et reconstituer la conversation
    function fetchAllMessages() {
      const password = sessionStorage.getItem('userPassword');
      const token = localStorage.getItem('token');
      if (!password || !token || !userId) {
        return alert("Erreur d'identification ou de s√©curit√©.");
      }
      const rsaReq = $.ajax({
        url: `http://localhost:3000/api/messages/${userId}`,
        method: "GET",
        headers: { 'Authorization': `Bearer ${token}`, 'Password': password }
      });
      const aesReq = $.ajax({
        url: `http://localhost:3000/api/conversations?userId=${userId}`,
        method: "GET",
        headers: { 'Authorization': `Bearer ${token}`, 'Password': password }
      });
      $.when(rsaReq, aesReq)
       .done(function(rsaRes, aesRes) {
         const rsaMsgs = rsaRes[0];
         const aesMsgs = aesRes[0];
         allMessages = [];
         rsaMsgs.concat(aesMsgs).forEach(storeMessage);
         allMessages.sort((a, b) => new Date(a.date_envoi) - new Date(b.date_envoi));
         displayConversation();
       })
       .fail(function() {
         alert("Impossible de r√©cup√©rer les messages.");
       });
    }

    // Affichage de la liste des utilisateurs
    function afficherUtilisateurs() {
      $.ajax({
        url: 'http://localhost:3000/api/users',
        type: "GET",
        success: function(users) {
          let html = "";
          users.forEach(user => {
            html += `<li onclick="selectRecipient(${user.id}, '${user.nom}')">${user.nom} (${user.email})</li>`;
          });
          $("#liste-utilisateurs").html(html);
        },
        error: function(xhr) {
          const err = xhr.responseJSON?.error || 'Une erreur est survenue';
          alert("Erreur: " + err);
        }
      });
    }

    // S√©lection d'un destinataire et rechargement de la conversation
    function selectRecipient(id, name) {
      selectedRecipientId = id;
      console.log("Destinataire s√©lectionn√© :", selectedRecipientId);
      $('#recipientName').text(name);
      displayConversation();
    }

    // Envoi d'un message (en affichant directement le dernier message en plus via WS)
    function sendMessage() {
      const text = $('#messageInput').val().trim();
      const type = $('#encryptionType').val();
      if (!text || !selectedRecipientId) {
        return alert("Message et destinataire requis.");
      }
      console.log("Message √† envoyer :", text, "Destinataire :", selectedRecipientId, "Mode :", type);
      const payload = {
        expediteur: userId,
        destinataire: selectedRecipientId,
        message: text,
        date_envoi: new Date().toISOString()
      };
      
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'chat', payload }));
      } else {
        console.error("WebSocket n'est pas ouvert, readyState =", ws.readyState);
      }
      
      displayMessage(text, "Moi", payload.date_envoi);
    
      const url = (type === 'rsa') ? '/api/send' : '/api/sendMessage';
      $.ajax({
        url: url,
        method: "POST",
        contentType: "application/json",
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        data: JSON.stringify({
          expediteur: payload.expediteur,
          destinataire: payload.destinataire,
          message: payload.message
        }),
        error: function() {
          alert(`Erreur d'envoi ${type.toUpperCase()}.`);
        }
      });
      $('#messageInput').val('');
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }

    $(document).ready(function () {
      const token = localStorage.getItem('token');
      if (!token) {
        return window.location.href = '/login';
      }
      $.ajax({
        url: 'http://localhost:3000/api/profil',
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        success: function (data) {
          $('#userName').text(data.nom);
          $('#userEmail').text(data.email);
          $('#userId').text(data.id);
          userId = data.id;
          $('#messagerieSection').show();
          connectWebSocket();
          fetchAllMessages();
          afficherUtilisateurs();
        },
        error: logout
      });
    });
  </script>
</body>
</html>
